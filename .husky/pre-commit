#!/usr/bin/env bash

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# Exit early if no staged files
[ -z "$STAGED_FILES" ] && exit 0

# Filter for cv-builder files only
CV_BUILDER_FILES=""
CV_BUILDER_FULL_PATHS=""
for file in $STAGED_FILES; do
  if [[ "$file" == cv-builder/* ]]; then
    # Strip the cv-builder/ prefix for prettier
    CV_BUILDER_FILES="$CV_BUILDER_FILES ${file#cv-builder/}"
    CV_BUILDER_FULL_PATHS="$CV_BUILDER_FULL_PATHS $file"
  fi
done

# Run prettier on cv-builder files if any
if [ -n "$CV_BUILDER_FILES" ]; then
  echo "Running Prettier on staged cv-builder files..."
  cd cv-builder

  # Format files with prettier
  bun prettier --write $CV_BUILDER_FILES 2>/dev/null

  cd ..

  # Re-add formatted files to staging (using full paths from root)
  for file in $CV_BUILDER_FULL_PATHS; do
    git add "$file" 2>/dev/null
  done
fi

# Run ESLint on cv-builder if there are staged ts/tsx files
CV_BUILDER_TS_FILES=""
for file in $STAGED_FILES; do
  if [[ "$file" == cv-builder/*.ts ]] || [[ "$file" == cv-builder/*.tsx ]]; then
    CV_BUILDER_TS_FILES="$CV_BUILDER_TS_FILES $file"
  fi
done

if [ -n "$CV_BUILDER_TS_FILES" ]; then
  echo "Running ESLint on staged TypeScript files..."
  cd cv-builder
  bun eslint --cache --cache-location .next/cache/eslint ${CV_BUILDER_TS_FILES//cv-builder\//} --max-warnings 0
  ESLINT_EXIT=$?
  cd ..

  if [ $ESLINT_EXIT -ne 0 ]; then
    echo "ESLint found errors. Please fix them before committing."
    exit 1
  fi
fi

# Run TypeScript type check on cv-builder if ts/tsx files changed
if [ -n "$CV_BUILDER_TS_FILES" ]; then
  echo "Running TypeScript type check..."
  cd cv-builder
  bun tsc --noEmit
  TSC_EXIT=$?
  cd ..

  if [ $TSC_EXIT -ne 0 ]; then
    echo "TypeScript found type errors. Please fix them before committing."
    exit 1
  fi
fi

exit 0
