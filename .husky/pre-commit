#!/usr/bin/env bash

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# Exit early if no staged files
[ -z "$STAGED_FILES" ] && exit 0

# Filter for cv-builder files only
CV_BUILDER_FILES=""
CV_BUILDER_TS_FILES=""

for file in $STAGED_FILES; do
  if [[ "$file" == cv-builder/* ]]; then
    rel_file="${file#cv-builder/}"
    CV_BUILDER_FILES="$CV_BUILDER_FILES $rel_file"

    if [[ "$rel_file" == *.ts ]] || [[ "$rel_file" == *.tsx ]]; then
      CV_BUILDER_TS_FILES="$CV_BUILDER_TS_FILES $rel_file"
    fi
  fi
done

# Exit if no cv-builder files
[ -z "$CV_BUILDER_FILES" ] && exit 0

# Run prettier on cv-builder files
echo "Running Prettier on staged cv-builder files..."
(cd cv-builder && bun prettier --write $CV_BUILDER_FILES 2>/dev/null)

# Re-add formatted files to staging
for file in $CV_BUILDER_FILES; do
  git add "cv-builder/$file" 2>/dev/null
done

# Run ESLint if there are ts/tsx files
if [ -n "$CV_BUILDER_TS_FILES" ]; then
  echo "Running ESLint on staged TypeScript files..."
  (cd cv-builder && bun eslint --cache --cache-location .next/cache/eslint --no-warn-ignored $CV_BUILDER_TS_FILES --max-warnings 0)
  if [ $? -ne 0 ]; then
    echo "ESLint found errors. Please fix them before committing."
    exit 1
  fi

  echo "Running TypeScript type check..."
  (cd cv-builder && bun tsc --noEmit)
  if [ $? -ne 0 ]; then
    echo "TypeScript found type errors. Please fix them before committing."
    exit 1
  fi

  echo "Running Knip (dead code detection)..."
  (cd cv-builder && bun knip) || echo "⚠️  Knip found issues (not blocking commit)"
fi

exit 0
